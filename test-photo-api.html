<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç API –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; max-height: 300px; }
        input { margin: 5px; }
    </style>
</head>
<body>
    <h1>üîç –¢–µ—Å—Ç API –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</h1>
    
    <div class="section">
        <h3>1. –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <button onclick="loadCategories()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
        <select id="categorySelect" onchange="loadProducts()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
        </select>
        <div id="categories-result"></div>
    </div>
    
    <div class="section">
        <h3>2. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã</h3>
        <div id="products-result"></div>
    </div>
    
    <div class="section">
        <h3>3. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</h3>
        <input type="file" id="photoFile" accept="image/*" multiple>
        <button onclick="testPhotoUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <div id="upload-result"></div>
    </div>

    <script>
        let selectedCategoryId = null;
        
        async function loadCategories() {
            const resultDiv = document.getElementById('categories-result');
            const select = document.getElementById('categorySelect');
            
            resultDiv.innerHTML = '<div class="info">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</div>';
            
            try {
                const response = await fetch('/api/catalog/categories');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${data.categories.length}</div>`;
                    
                    // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º select
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function loadProducts() {
            selectedCategoryId = document.getElementById('categorySelect').value;
            
            if (!selectedCategoryId) {
                document.getElementById('products-result').innerHTML = '';
                return;
            }
            
            const resultDiv = document.getElementById('products-result');
            resultDiv.innerHTML = '<div class="info">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
            
            try {
                const response = await fetch(`/api/catalog/products?category=${selectedCategoryId}&limit=5`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `<div class="success">‚úÖ –¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${data.products.length}</div>`;
                    
                    data.products.forEach((product, index) => {
                        const props = product.properties_data || {};
                        const keys = Object.keys(props);
                        const hasPhotos = props.photos ? `–î–ê (${props.photos.length})` : '–ù–ï–¢';
                        
                        html += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                                <strong>–¢–æ–≤–∞—Ä ${index + 1}:</strong> ${product.name}<br>
                                <strong>SKU:</strong> ${product.sku}<br>
                                <strong>–§–æ—Ç–æ:</strong> ${hasPhotos}<br>
                                <strong>–°–≤–æ–π—Å—Ç–≤–∞:</strong> ${keys.length} –∫–ª—é—á–µ–π
                                ${keys.length > 0 ? `<br><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong> ${keys.slice(0, 3).join(', ')}` : ''}
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testPhotoUpload() {
            const fileInput = document.getElementById('photoFile');
            const files = fileInput.files;
            
            if (files.length === 0) {
                document.getElementById('upload-result').innerHTML = 
                    '<div class="error">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                return;
            }
            
            if (!selectedCategoryId) {
                document.getElementById('upload-result').innerHTML = 
                    '<div class="error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>';
                return;
            }
            
            const resultDiv = document.getElementById('upload-result');
            resultDiv.innerHTML = '<div class="info">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</div>';
            
            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('photos', files[i]);
                }
                formData.append('category', selectedCategoryId);
                formData.append('mapping_property', '–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞');
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', {
                    photos: files.length,
                    category: selectedCategoryId,
                    mapping_property: '–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞'
                });
                
                const response = await fetch('/api/admin/import/photos', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    let html = `<div class="success">‚úÖ –ó–ê–ì–†–£–ó–ö–ê –£–°–ü–ï–®–ù–ê!</div>`;
                    html += `<div><strong>–ó–∞–≥—Ä—É–∂–µ–Ω–æ:</strong> ${data.uploaded} —Ñ–∞–π–ª–æ–≤</div>`;
                    html += `<div><strong>–ü—Ä–∏–≤—è–∑–∞–Ω–æ:</strong> ${data.linked} —Ç–æ–≤–∞—Ä–æ–≤</div>`;
                    html += `<div><strong>–û—à–∏–±–æ–∫:</strong> ${data.errors}</div>`;
                    
                    if (data.details && data.details.length > 0) {
                        html += `<div><strong>–î–µ—Ç–∞–ª–∏:</strong></div>`;
                        data.details.forEach((detail, index) => {
                            html += `<div style="margin-left: 20px;">${index + 1}. ${detail.fileName}: ${detail.message}</div>`;
                        });
                    }
                    
                    html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
                    resultDiv.innerHTML = html;
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    setTimeout(() => loadProducts(), 2000);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Upload error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadCategories();
        };
    </script>
</body>
</html>



