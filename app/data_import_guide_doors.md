# Руководство по импорту данных (Пилот: Doors)

**Дата:** 2025‑09‑10\
**Цель:** загрузить стартовую номенклатуру и поддерживать обновления через админку (без кода).

---

## 1) Подготовка файла

- Формат: **XLSX/CSV**.
- Лист/диапазон: как в `import.mapping.json` (пример ниже).
- Кодировка CSV: UTF‑8 (разделитель `;`/`,` — не критично, указывать при импорте).

**Анти‑CSV инъекции:** поля, начинающиеся с `=`, `+`, `-` — экранировать префиксом `'`.

---

## 2) Маппинг полей (пример)

```json
{
  "mapping": {
    "model": "Модель",
    "style": "Стиль",
    "finish": "Покрытие",
    "domeo_color": "Цвет",
    "type": "Тип",
    "width": "Ширина",
    "height": "Высота",
    "rrc_price": "РРЦ",
    "photo_url": "Фото"
  },
  "uniqueBy": ["model","finish","domeo_color","type","width","height"],
  "sheet": "Каталог",
  "startRow": 2
}
```

**Обязательные для ****\`\`****:** `model, finish, domeo_color/color, type, width, height, rrc_price`.

---

## 3) Ключ витрины и конфликты РРЦ

- **Ключ витрины:** `(model, finish, domeo_color, type, width, height)` — один «комплект двери».
- Если у ключа разные РРЦ от поставщиков:
  1. Импорт помечает **конфликт**;
  2. Формируется **отчёт CSV** (`/static/import_reports/doors/*.csv`);
  3. **Каноническая РРЦ**: по умолчанию — **минимальная**, админ может выбрать/внести вручную (среднюю и т.п.).

---

## 4) Процедура импорта в админке

1. Откройте категорию **Doors** → **Import**.
2. Загрузите файл `Номенклатура_Двери_*.xlsx`.
3. Проверьте маппинг колонок; исправьте при необходимости.
4. Запустите **валидацию**.
5. Просмотрите **ошибки/предупреждения**; скачайте отчёт.
6. Утвердите **каноническую РРЦ** для конфликтов.
7. Примените **UPSERT** в БД.
8. Обновите **STATE.md** (ссылка на отчёт, числа added/updated/skipped).

---

## 5) Проверка данных (smoke‑тесты)

**Опции:**

```
curl -s "https://api.example.com/catalog/doors/options?style=Современная&type=Пенал" | jq
```

**Цена:**

```
curl -s -X POST https://api.example.com/price/doors \
  -H 'Content-Type: application/json' \
  -d '{"selection":{"model":"Modern-1","finish":"Шпон","color":"Белый","type":"Пенал","width":900,"height":2000,"hardware_kit":{"id":"KIT_SOFT","price":4200},"handle":{"id":"HNDL_B","price":1400}}}' | jq
```

**Экспорт КП:**

```
curl -s -X POST https://api.example.com/cart/export/doors/kp \
  -H 'Content-Type: application/json' \
  -d '{"cart":{"items":[{"model":"Modern-1","type":"Пенал","parameters":"Шпон, Белый, 900×2000","qty":1,"unitPrice":34450,"sum":34450}]},"currency":"RUB","price":{"breakdown":[]}}' > kp.html
```

---

## 6) Обновления в будущем

- Новые прайсы импортируются тем же образом (версионирование сохраняется).
- Перед публикацией рекомендуется создать PIT‑бэкап БД.

