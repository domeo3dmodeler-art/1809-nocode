Title: Domeo — Spec КП (вывод и формулы)
Owner: @Analyst + @TechLead
Last updated (Europe/Paris): 2025-09-11
Related: [Master Spec](./master_spec.md), [Admin Guide](./admin_guide.md), [Data Import Guide Doors](./data_import_guide_doors.md),
         [Roadmap](./roadmap.md), [State](./state.md), [Sync Guide](./sync_guide.md)

# Коммерческое предложение (КП) — правила вывода

---

## Колонки таблицы КП

1. **№** — порядковый номер позиции (сквозная нумерация).  
2. **Наименование** — собранная строка:  
{{Модель}} ({{Ширина}}×{{Высота}}, {{Цвет}}{{, Кромка: {{Если кромка да}}}})
- Если `Кромка == "да"` и заполнено поле «Если кромка да» → добавить `, Кромка: …`.  
- Если `Кромка == "да"`, но поле пустое → добавить `, Кромка`.  
- Если `Кромка != "да"` → фрагмент про кромку не выводить.  
3. **Цена РРЦ, руб** — из CSV («Цена ррц …»). Округление до целого, разделитель тысяч — пробел.  
4. **Количество** — из корзины (по умолчанию 1).  
5. **Сумма, руб** — `Цена РРЦ × Количество`.  

---

## Подстрока для выбранной ручки

- Выводится под строкой двери, если ручка выбрана.  
- Формат:  
Ручка: {{handle.name}} — {{handle.price}} × {{qty}} = {{handle.total}}
- В таблице:  
- № — пусто,  
- Наименование — «Ручка: …»,  
- Цена РРЦ — цена ручки,  
- Количество — = qty двери,  
- Сумма — цена × qty.  

---

## Итерация по корзине

- Все двери из корзины в указанном порядке.  
- Каждая дверь → основная строка + строка ручки (если есть).  

---

## Проверки и валидация

- Если нет ширины/высоты → выводим только доступные атрибуты.  
- Если цвет пуст → цвет в скобках не выводим.  

---

## Пример (фиктивные данные)

1 | Moderno (800×2000, Белый, Кромка: ABS BLACK) | 39 900 | 2 | 79 800
| Ручка: HNDL_B — 1 400 × 2 = 2 800


---

## Карта соответствий полей (КП)

- Название модели → `Domeo_Название модели для Web`  
- Ширина → `Ширина/мм`  
- Высота → `Высота/мм`  
- Цвет → `Domeo_Цвет`  
- Кромка / Вид кромки → `Кромка`, `Если кромка да`  
- Цена РРЦ → `Цена ррц (вкл. полотна, короба, наличников, доборов)`  
- Количество → из корзины  

---

# Заказ на фабрику — колонки и расчёты

Документ формируется для внутренней передачи поставщику.  

---

## Основная строка (дверь)

1. **Номер п/п** — автонумерация (без учёта ручек).  
2. **Поставщик** *(supplier)* — поле «Поставщик» из CSV.  
3. **Фабрика_Коллекция** *(collection)* — CSV.  
4. **Наименование поставщика** *(supplier_item_name)* — CSV.  
5. **Фабрика_Цвет/Отделка** *(supplier_color_finish)* — CSV.  
6. **Ширина/мм** *(width)* — CSV.  
7. **Высота/мм** *(height)* — CSV.  
8. **Фурнитура (Ценовая группа)** *(hardware_kit.name, group)*  
   - Формат: `"<Комплект> (гр. <Группа>)"`.  
   - Если комплект не выбран → пусто.  
9. **Цена опт, руб** *(price_opt)* — CSV «Цена опт».  
10. **Цена, руб (РРЦ + комплект)** — `rrc_price + hardware_kit.price_rrc`.  
11. **Кол-во** *(qty)* — из корзины.  
12. **Сумма опт, руб** — `price_opt × qty`.  
13. **Сумма РРЦ, руб** — `(rrc_price + hardware_kit.price_rrc) × qty`.  

---

## Дополнительная строка (ручка)

Если выбрана ручка → добавляется строка.  

- **Наименование Web** *(handle.name_web)*  
- **Фабрика_наименование** *(handle.supplier_name)*  
- **Фабрика_артикул** *(handle.supplier_sku)*  
- **Количество** *(handle.qty, по умолчанию = qty двери)*  
- **Цена опт** *(handle.price_opt)*  
- **Группа_цена** *(handle.price_group_multiplier)*  
- **Сумма опт** = `price_opt × qty`  
- **Цена розница** = `price_opt × group_multiplier`  

---

## Общие правила

- Денежные значения округляются до 2 знаков.  
- Разделитель дробной части зависит от шаблона (точка/запятая).  
- Строки ручек не увеличивают счётчик «№ п/п».  
- Экспорт в CSV/XLSX.  

---

## Пример (фиктивные данные)

1 | Поставщик1 | Коллекция A | Дверь Модерн 1 | Белый шпон | 800 | 2000 | Комплект SoftClose (гр. 2) | 25 000 | 39 900 | 2 | 50 000 | 79 800
| — | — | Ручка: HNDL_B | — | — | — | — | 1 200 | 1 400 | 2 | 2 400 | 2 800



---

# Счёт заказчику — правила вывода

---

## Основная строка

1. **№** — порядковый номер.  
2. **Артикул** — поле «Domeo Артикул 1С».  
3. **Наименование** — как в КП.  
4. **Цена, руб** — Цена РРЦ.  
5. **Кол-во** — из корзины.  
6. **Сумма, руб** — `Цена × Кол-во`.  

---

## Подстрока для ручки

- **Артикул** — Domeo артикул ручки 1С.  
- **Наименование Web** — наименование ручки.  
- **Цена, руб** — из «ЦеныГруппРучек».  
- **Кол-во** — из корзины.  
- **Сумма, руб** — `Цена × Кол-во`.  

---

## Примечание

- Нумерация «№» только по дверям.  
- Строки ручек не увеличивают счётчик.  

---

# Версионирование

- v1.0 (2025-09-11): стартовая версия для пилота Doors.  
- Будущие изменения фиксировать с датой вступления в силу.  

