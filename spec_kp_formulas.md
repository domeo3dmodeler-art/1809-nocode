Title: Domeo — Spec КП (вывод и формулы)
Owner: @Analyst + @TechLead
Last updated (Europe/Paris): 2025-09-13
Related: [Master Spec](./master_spec.md), [Admin Guide](./admin_guide.md), [Data Import Guide Doors](./data_import_guide_doors.md),
         [Roadmap](./roadmap.md), [State](./state.md), [Sync Guide](./sync_guide.md)

# Коммерческое предложение (КП) — правила вывода

---

## Расчёт цены (Doors) — актуализация 2025-09-13
- `base = products.rrc_price`  
- `kit_add = kits.price_rrc` (если выбран комплект)  
- `handle_add = round(handles.price_opt * handles.price_group_multiplier)` (если выбрана ручка)  
- `total = base + kit_add + handle_add`  
- `currency = "RUB"`, округление до рубля.

---

## Колонки таблицы КП
1. **№** — порядковый номер позиции (сквозная нумерация).  
2. **Наименование** — собранная строка:  
   `{{Модель}} ({{Ширина}}×{{Высота}}, {{Цвет}}{{, Кромка: {{Если кромка да}}}})`  
   - Если `Кромка == "да"` и заполнено поле «Если кромка да» → добавить `, Кромка: …`.  
   - Если `Кромка == "да"`, но поле пустое → добавить `, Кромка`.  
   - Если `Кромка != "да"` → фрагмент про кромку не выводить.  
3. **Цена РРЦ, руб** — из каталога; разделитель тысяч — пробел.  
4. **Количество** — из корзины (по умолчанию 1).  
5. **Сумма, руб** — `Цена РРЦ × Количество`.

---

## Подстрока для выбранной ручки
- Выводится под строкой двери, если ручка выбрана.  
- Формат: `Ручка: {{handle.name}} — {{handle.price}} × {{qty}} = {{handle.total}}`  
- В таблице: № — пусто; Наименование — «Ручка: …»; Цена — цена ручки; Количество — qty двери; Сумма — цена × qty.

---

## Итерация по корзине
- Все двери из корзины в указанном порядке.  
- Каждая дверь → основная строка + строка ручки (если есть).

---

## Проверки и валидация
- Если нет ширины/высоты → выводим только доступные атрибуты.  
- Если цвет пуст → цвет в скобках не выводим.

---

## Карта соответствий полей (КП)
- Название модели → `Domeo_Название модели для Web`  
- Ширина → `Ширина/мм`  
- Высота → `Высота/мм`  
- Цвет → `Domeo_Цвет`  
- Кромка / Вид кромки → `Кромка`, `Если кромка да`  
- Цена РРЦ → `Цена ррц (вкл. полотна, короба, наличников, доборов)`  
- Количество → из корзины

---

# Заказ на фабрику — колонки и расчёты

Документ формируется для внутренней передачи поставщику.

## Основная строка (дверь)
1. **Номер п/п** — автонумерация (без учёта ручек).  
2. **Поставщик** — поле «Поставщик» из импорта.  
3. **Фабрика_Коллекция** — из импорта.  
4. **Наименование поставщика** — из импорта.  
5. **Фабрика_Цвет/Отделка** — из импорта.  
6. **Ширина/мм** — из импорта.  
7. **Высота/мм** — из импорта.  
8. **Фурнитура (Ценовая группа)** — `"<Комплект> (гр. <Группа>)"`; если не выбран — пусто.  
9. **Цена опт, руб** — «Цена опт» (если доступно).  
10. **Цена, руб (РРЦ + комплект)** — `rrc_price + hardware_kit.price_rrc`.  
11. **Кол-во** — из корзины.  
12. **Сумма опт, руб** — `price_opt × qty`.  
13. **Сумма РРЦ, руб** — `(rrc_price + hardware_kit.price_rrc) × qty`.

## Дополнительная строка (ручка)
- Выводится, если выбрана ручка.  
- Поля: `handle.name_web`, `supplier_name`, `supplier_sku`, `qty = qty двери`, `price_opt`, `price_group_multiplier`, `sum_opt = price_opt × qty`, `retail = round(price_opt × multiplier)`.

---

# Счёт заказчику — правила вывода

## Основная строка
1. **№** — порядковый номер.  
2. **Артикул** — «Domeo Артикул 1С».  
3. **Наименование** — как в КП.  
4. **Цена, руб** — РРЦ.  
5. **Кол-во** — из корзины.  
6. **Сумма, руб** — `Цена × Кол-во`.

## Подстрока для ручки
- **Артикул** — артикул ручки 1С.  
- **Наименование Web** — имя ручки.  
- **Цена, руб** — из «ЦеныГруппРучек» (опт×множитель).  
- **Кол-во** — из корзины.  
- **Сумма, руб** — `Цена × Кол-во`.

---

# Версионирование
- v1.1 (2025-09-13): добавлена формула расчёта Doors и уточнён экспорт.  
- v1.0 (2025-09-11): стартовая версия для пилота Doors.
