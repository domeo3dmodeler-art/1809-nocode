# Domeo — Spec КП (вывод и формулы)
Owner: @Analyst + @TechLead
Last updated (Europe/Paris): 2025-09-20
Related: [Master Spec](./master_spec.md), [Admin Guide](./admin_guide.md), [Data Import Guide Doors](./data_import_guide_doors.md),
         [Roadmap](./roadmap.md), [State](./state.md), [Sync Guide](./sync_guide.md)

# Коммерческое предложение (КП) — правила вывода

---

## Расчёт цены (Doors) — актуализация 2025-09-20
- `base = products.rrc_price`  
- `kit_add = kits.price_rrc` (если выбран комплект)  
- `handle_add = round(handles.price_opt * handles.price_group_multiplier)` (если выбрана ручка)  
- `total = base + kit_add + handle_add`  
- `currency = "RUB"`, округление до рубля.

---

## Колонки таблицы КП
1. **№** — порядковый номер позиции.  
2. **Наименование** — `{{Модель}} ({{Ширина}}×{{Высота}}, {{Цвет}}{{, Кромка: {{Если кромка да}}}})` (по правилам).  
3. **Цена РРЦ, руб** — из каталога.  
4. **Количество** — из корзины (по умолчанию 1).  
5. **Сумма, руб** — `Цена РРЦ × Количество`.

---

## Подстрока для выбранной ручки
- Формат: `Ручка: {{handle.name}} — {{handle.price}} × {{qty}} = {{handle.total}}`.  
- В таблице: № — пусто; Наименование — «Ручка: …»; Цена — цена ручки; Количество — qty двери; Сумма — цена × qty.

---

## Итерация по корзине
- Все двери из корзины в порядке добавления.  
- Каждая дверь → основная строка + строка ручки (если есть).

---

## Карта соответствий полей (КП)
- Название модели → `Domeo_Название модели для Web`  
- Ширина → `Ширина/мм`  
- Высота → `Высота/мм`  
- Цвет → `Domeo_Цвет`  
- Кромка → `Кромка`, `Если кромка да`  
- Цена РРЦ → `Цена ррц (вкл. полотна, короба, наличников, доборов)`  
- Количество → из корзины

---

# Заказ на фабрику — правила вывода

## Основная строка (дверь)
1. **Номер п/п** — автонумерация.  
2. **Поставщик** — поле «Поставщик».  
3. **Фабрика_Коллекция** — из импорта.  
4. **Наименование поставщика** — из импорта.  
5. **Фабрика_Цвет/Отделка** — из импорта.  
6. **Ширина/мм** — из импорта.  
7. **Высота/мм** — из импорта.  
8. **Фурнитура** — `"<Комплект> (гр. <Группа>)"`, если выбран.  
9. **Цена опт, руб** — «Цена опт».  
10. **Цена РРЦ, руб** — `rrc_price + hardware_kit.price_rrc`.  
11. **Кол-во** — из корзины.  
12. **Сумма опт, руб** — `price_opt × qty`.  
13. **Сумма РРЦ, руб** — `(rrc_price + kit.price_rrc) × qty`.

## Доп. строка (ручка)
- Поля: `handle.name_web`, `supplier_name`, `supplier_sku`, `qty`, `price_opt`, `price_group_multiplier`, `sum_opt`, `retail`.

---

# Счёт заказчику

## Основная строка
1. **№** — порядковый номер.  
2. **Артикул** — «Domeo Артикул 1С».  
3. **Наименование** — как в КП.  
4. **Цена, руб** — РРЦ.  
5. **Кол-во** — из корзины.  
6. **Сумма, руб** — `Цена × Кол-во`.

## Подстрока для ручки
- **Артикул** — артикул ручки 1С.  
- **Наименование Web** — имя ручки.  
- **Цена, руб** — опт×множитель.  
- **Кол-во** — qty.  
- **Сумма, руб** — `Цена × Кол-во`.

---

# Версионирование
- v1.2 (2025-09-20): убран HTML-экспорт, оставлен только PDF.  
- v1.1 (2025-09-13): формула Doors.  
- v1.0 (2025-09-11): стартовая версия.
